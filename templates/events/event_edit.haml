- extends 'base.haml'

- block 'head'
  {{ form.media }}

- block 'subnav-container' 
  .subnav
    .row
      .span12
        %h2 Editing {{event}}

- block 'content'
  #event-new
    .row.buffer
      .span6
        .row
          .span6
            %label{for:"name"} Event Name:
            %input#name{name:"name", type:"text", value:"{{event.name}}"}

          .span6
            %label{for:"id_location"} Location:
            %input#id_location{placeholder:"Enter the location name or city or state", type:"text", autocomplete:"off", value:"{{event.location.form_str}}"}

            %span.search.addon
              %i.icon-search

            %button#add-location.btn.btn-warning{href:"#add-location-popup"}
              %i.icon-plus

          .span3
            %label{for:"start-date"} Start Date:
            %input#start-date{name:"start-date", type:"text", value:"{{start_date}}"}
          .span3
            %label{for:"start-time"} Start Time:
            %input#start-time{name:"start-time", type:"text", value:"{{start_time}}"}

          .span3
            %label{for:"end-date"} End Date:
            %input#end-date{name:"end-date", type:"text", value:"{{end_date}}"}
          .span3
            %label{for:"end-time"} End Time:
            %input#end-time{name:"end-time", type:"text", value:"{{end_time}}"}

          .span6
            %button#submit-event.btn.btn-warning
              Save Event

      .span6
        #map

  %div{style:"display:none"}
    #add-location-popup{style:"background-color:white; padding: 40px;"}
      %h2 Add New Location
      %form{action:"/location/new?next=/event/new", method:"POST"}
        - csrf_token
        {{ location_form.as_p }}

        %button.btn.btn-warning{type:"submit"} Add Location

- block 'scripts'
  %script{type:"text/javascript"}
    $('#add-location').colorbox({inline: true, width:"400px"});

    L.Icon.Default.imagePath = '{{STATIC_URL}}img/';

    // create a map in the "map" div, set the view to a given place and zoom
    var map = L.map('map').setView([39.95, -82.95], 6);

    // add an OpenStreetMap tile layer
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

    var locationModels = {}
    var locations = []

    var currentLocation = null;
    - for location in locations
      var name = "{{location.form_str}}"
      locations.push(name);
      locationModels[name] = {
          id: "{{location.pk}}",
          querystring: "{{location.geocode_querystring}}"
      };

      if({{event.location.id}} == {{location.id}}) {
        currentLocation = locationModels[name]
      }

      var url = "http://nominatim.openstreetmap.org/search/{{location.geocode_querystring}}?format=json";

      $.get(url, function(data) {
          if(data.length != 0) {
              L.marker([data[0].lat, data[0].lon]).addTo(map).bindPopup(
                  '<h4><a href="{{location.get_absolute_url}}">{{location.name}}</a></h4><br />{{location.address}}<br />{{location.city}}, {{location.state}} {{location.zip_code}}');
          }
      });

    updateLocation = function(location) {
        var url = "http://nominatim.openstreetmap.org/search/" + location.querystring + "?format=json";

        $.get(url, function(data) {
            if(data.length != 0) {
                map.setView([data[0].lat, data[0].lon], 12);
            }
        });
    }

    $('#id_location').typeahead({
        source: locations, 
        updater: function(selection){
            currentLocation = locationModels[selection];
            updateLocation(currentLocation);

            return selection;
        }
    });

    if(currentLocation) {
        updateLocation(currentLocation);
    }

    var nowTemp = new Date();
    var now = new Date(nowTemp.getFullYear(), nowTemp.getMonth(), nowTemp.getDate(), 0, 0, 0, 0);

    $('#start-date').datepicker({ format: 'mm/dd/yyyy' });
    $('#end-date').datepicker({ format: 'mm/dd/yyyy' });

    $('#start-date').on('changeDate', function() {
      $('#start-date').datepicker('hide');
    });

    $('#end-date').on('changeDate', function() {
      $('#end-date').datepicker('hide');
    });

    $('#start-time').timepicker({
      template: false,
      showInputs: false,
      minuteStep: 5
    });

    $('#end-time').timepicker({
      template: false,
      showInputs: false,
      minuteStep: 5
    });

    $('#submit-event').on('click', function(){
        $.post("/event/{{event.id}}/edit", {
            'name': $('#name').val(),
            'description': $('#description').val(),
            'location': currentLocation.id,
            'start-date': $("#start-date").val(),
            'start-time': $("#start-time").val(),
            'end-date': $("#end-date").val(),
            'end-time': $("#end-time").val(),
        }, function(){
            window.location = "{{event.get_absolute_url}}";
        });
    });
