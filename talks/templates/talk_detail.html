{% extends 'talk_base.html' %}

{% block 'content' %}
<div id="talk">
    {% include '_talk_header_partial.html' %}
    <div class="row">
        <div class="span3">
            <div class="row">
                <div class="span3">
                    <div class="tags">
                        <h3>Tags</h3>
                        <ul>
                            {% for tag in talk.tags.all %}
                            <li>{{ tag.name }}</li>
                            {% endfor %}
                        </ul>

                        <form action="/talk/{{talk.id}}/tag/new/" method="POST">
                            {% csrf_token %}
                            <input name="tag" type="text" placeholder="My Tag"/>
                            <input class="btn btn-warning" type="submit" value="Tag this talk" />
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="span9">
            <div class="talk-detail">
                {% if talk.talkvideo_set.all %}
                    <h3>Videos</h2>
                    {% for video in talk.talkvideo_set.all %}
                        {% if video.video_type == "YOUTUBE" %}
                            <iframe width="300" height="225" src="{{ video.url_target }}" frameborder="0" allowfullscreen></iframe>
                        {% elif video.video_type == "VIMEO" %}
                            <iframe src="{{ video.url_target }}" width="300" height="225" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if attendees %}
                    <h3>Attendees</h3>
                    {% for profile in attendees %}
                        <a href="/speaker/{{profile.user.username}}">{{profile.user.get_full_name}}</a>
                    {% endfor %}
                {% endif %}

                {% if events or talk.speaker == user.get_profile and events %}
                    <div class="row">
                        <div class="span9">
                            <h3>Future Events</h3>

                            <div class="row">
                                <div id="locations">
                                    {% for event in events %}
                                        {% with event.location as location %}
                                            <div class="span9">
                                                <div class="location">
                                                    <div class="map" id="map{{location.id}}"></div>
                                                    <div class="details">
                                                        <h3><a href="/event/{{event.id}}">{{ location.name }}</a></h3>

                                                        {{ location.address }}<br />
                                                        {{ location.city }}, {{location.state}}, {{location.zip_code}}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if talk.talkcomment_set.all or talk.speaker != user.get_profile %}
                    <div class="comments">
                        <h3>Comments</h3>

                        {% if talk.speaker != user.get_profile %}
                            <form class="add-comment-form" action="/talk/{{talk.id}}/comment/new/" method="POST">
                                {% csrf_token %}
                                <textarea name='comment' placeholder="Add your comment..."></textarea><br />
                                <input class="btn btn-warning" type="submit" value="Submit Comment" />
                            </form>
                        {% endif %}

                        {% if talk.talkcomment_set.all %}
                            <ul>
                                {% for comment in talk.talkcomment_set.all %}
                                    <li>
                                        <h4>{{comment.reviewer.user.get_full_name}} said...</h4>
                                        <p>
                                            {{comment.comment}}
                                        </p>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block 'scripts' %}
<script type="text/javascript">
    $('.delete-talk').colorbox({inline: true, width:"400px"});

    $('.delete-talk').click(function(el){
        var sel = $(el.currentTarget)

        $('.delete-talk-name').text(sel.data('name'))
        $('.delete-confirm-link').attr('href', "/talk/" + sel.data('id') + "/delete/")
    });

    L.Icon.Default.imagePath = '{{STATIC_URL}}img/';

    {% for event in events %}
        {% with event.location as location %}
        (function() {
            // create a map in the "map" div, set the view to a given place and zoom
            var map = L.map('map{{location.id}}', {'zoomControl': false}).setView([39.95, -82.95], 6);

            // add an OpenStreetMap tile layer
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: ''
                }).addTo(map);

            var url = "http://nominatim.openstreetmap.org/search/{{location.geocode_querystring}}?format=json"
            $.get(url, function(data) {
                if(data.length != 0) {
                    L.marker([data[0].lat, data[0].lon]).addTo(map);
                    map.setView([data[0].lat, data[0].lon], 14);
                }
            });
        }).call(this);
        {% endwith %}
    {% endfor %}
</script>
{% endblock %}
